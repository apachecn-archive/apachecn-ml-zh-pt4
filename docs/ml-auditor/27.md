# 27.日志分析

本章着眼于对组织生成的系统和应用程序日志的分析。它展示了如何使用日志来获得洞察力，更好地了解业务，并识别系统和应用程序的高风险区域。高风险区域的知识可以用于内部审计的风险评估过程。

这一章的结构就像一个食谱——食谱的目标、配料、说明、变化和服务。随附的代码可以在第 [20](20.html) 章指定的 GitHub 存储库中获得。

## 菜肴:NLP 日志分析

几乎所有组织都以各种方式创建日志。它们可以用来记录服务器或应用程序上的活动。记录的活动用作审计跟踪，以确定在给定的时间段内应用程序上发生了什么。网络安全团队使用日志作为一种方法来确定是否发生了恶意行为。工程团队还可以使用日志来检测和修复与维护相关的问题。在此分析中，我们将了解内部审计团队如何利用日志来查看使用主题建模的应用程序的高风险区域。主题建模是一种自然语言处理(NLP)算法，可以预测给定文本集的主题。在此分析中，主题建模用于预测给定日志生成的日志类型。例如，如果日志中的所有行都可以标记为成功完成、失败或发生了其他事件，这将会很有帮助。这种分析对于 IT 审核员缩小显示业务面临持续挑战的领域很有价值。这也可以作为一种方式来确认从审计的另一个领域现有的调查结果。

## 佐料

测试数据中的每个日志条目由管道操作符(“|”)分隔的四列组成。以下是示例日志中的一个示例条目:

*   **2021-01-01 08:20:00|MKSEK| "开始进程" | "进程 A"**

包含多个单词的列通常用(")括起来。这告诉 Python 中的文本解析器单词的组合是单个列的一部分。

这些列的标题是日期时间、用户、日志和进程。

表 27-1

test.log 的列列表

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

圆柱

 | 

描述

 |
| --- | --- |
| 日期时间 | 日志条目的日期和时间 |
| 用户 | 生成事件的用户的用户名。 |
| 原木 | 事件的描述 |
| 过程 | 与事件关联的进程的名称。 |

## 说明

这个分析有四个步骤。首先是数据准备。接下来是探索性分析，它本身可以分为三个阶段或部分。然后是主题建模，接下来可能是重新进行分析。

### 步骤 1:数据准备

使用`read_csv()`功能中的选项将日志数据加载到数据框中，并分配相应的标题。

此分析的数据准备步骤包括在日志中筛选我们期望在日志中找到的特定关键字。在这种情况下，我们过滤日志条目，只显示包含“失败”、“错误”、“开始”和“完成”的条目

最后，所有日志条目的日志描述中的所有字母都被转换成小写字母。这确保了如果有一个条目包含单词“fail ”,而另一个条目包含“Fail ”,它们仍然被计为相同的关键字，而不会被标记为两个不同的单词。

### 步骤 2:探索性数据分析

探索性数据分析分为三个主要部分。首先，基于所有日志条目的描述生成词云。词云是给定文本中重复出现的词的图形表示。虽然词云在过去的十年中被大量使用，但在使用词云时，一个未被充分利用的功能是“停用词”。“停止单词”是一个单词列表，您告诉单词云生成器在将它们绘制到屏幕上时忽略它们。一些停用词是“the”、“is”、“are”等。这对于筛选可能生成数十万字的数百万行日志条目是必不可少的。许多 NLP 库现在配备了预先选择的停用词，可以用来过滤掉常用的英语单词。在许多情况下，可能需要根据所查看的日志和所传递的消息的性质来指定额外的停用词。例如，在我们的示例日志中，单词“process”和“run”被过度使用，在单词 cloud 中出现并没有增加任何价值。所以，这些词被添加为停用词。

单词“starting”在示例中使用次数最多，接下来是“completed”、“successfully”、“errors”、“encountered”和“failed”这告诉我们，日志中出现的错误与完成的数量一样多。

分析的下一部分集中在 n 元语法上。n-gram 的工作方式类似于单词云，因为它们跟踪单词的频率。频率通常用直方图表示。在我们的分析中，我们进行了一个词(1 个单词)和一个词(2 个单词)的分析。unigram 的结果验证了我们在之前对单词 clouds 的分析中发现的内容，但它现在告诉了我们单词的确切频率。二元模型分析表明，“成功完成”是日志中最常见的重复单词组合，其次是“遇到错误”和“遇到失败”我们可以看到，成功和失败的流程条目都有一个主题。

分析的最后部分显示了一个散点图(如图 [27-1](#Fig1) 所示), Y 轴表示与日志条目相关的过程，X 轴表示日志条目生成的相应时间。带有“错误”关键字的日志条目被过滤并绘制在散点图中。

![](../images/513842_1_En_27_Chapter/513842_1_En_27_Fig1_HTML.png)

图 27-1

散点图显示流程及其生成时间

图 [27-1](#Fig1) 说明除了流程 A 和流程 e，所有流程都失败了，大部分失败的流程发生在 2 月初。这一发现可能是与被审核方的一个很好的谈话点，以进一步确认对业务的了解。如果被审核方以前从未见过这种情况，相同的发现可以成为增值的洞察力，企业可以利用它来更好地解决流程中的差距。审计师可以通过将这些简单而有力的见解公之于众来加强他们作为可信赖的顾问的角色。

### 步骤 3:执行主题建模

在主题建模步骤中，通过从样本数据构建潜在的狄利克雷分配(LDA)模型来生成实际的 NLP 机器学习模型。该算法试图提出不同的主题，以及在每个主题中看到的单词的组合及其频率。有趣的是，当我们选择两个主题时，第一个主题包含成功的流程事件，第二个主题包含失败的流程运行。样本数据集显示了 LDA 模型如何从日志条目描述中归纳出成功和失败的运行。这种经过训练的模型现在可以用于更大的数据集，以分配成功和失败的主题。

### 步骤 4:重新进行分析

每当日志的结构改变或者用于记录日志的机制经历更新时，都需要重新训练 LDA 模型。日志生成活动通常不会改变，因此模型可能不需要定期重新训练。仍然需要对结果进行监控，以确保模型按预期运行。

## 变化和服务

在分析开始时知道过滤哪些关键词是一个反复试验的过程。它包括实验，以找到可以忽略的条目和可以用来解决手头业务问题的条目。

对于这个分析和样本数据，主题的数量被指定为两个，这导致了准确的主题分配。对于其他数据集，主题的数量会发生变化。探索多个主题及其在数据集上的相应表现将有助于确定最终模型的合适数量。

就部署而言，该模型可以在特定的基础上重新训练。当原始模型的性能下降或者数据结构发生变化时，可以进行重新训练。一旦训练完成，模型就可以部署到生产中，并且这个循环可以继续。

对于高风险的情况，可以自动进行前面的再训练，并且可以实现更实时或连续的流式应用。该应用程序可以设置为在生成新的日志条目时利用 LDA 模型来分配主题。运行失败的主题可能会上报给内部审计团队进行进一步审查和跟进。

## 结论

在本章中，你已经看到了一个如何查看系统和应用程序日志的例子。分析此类日志有助于您更好地了解业务，有时还能帮助您识别需要仔细检查的系统和应用程序的高风险方面。您对这些高风险方面的了解在您的风险评估过程中也很有用。