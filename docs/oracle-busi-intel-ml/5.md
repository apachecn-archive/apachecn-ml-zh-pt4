# 5.用例:OBIEE 12c 中的机器学习

我们已经讨论了机器学习以及大数据和云计算与 BI 的相关性。您已经了解了主要的 R 技术和 Oracle R Enterprise，它们描述了如何使用基于 R 的算法在 Oracle 12c 中构建模型。在 OBIEE 仪表盘中使用这些算法让你在机器学习和 OBIEE 上有了一个飞跃。所有这些，再加上第 4 章[的](4.html)，其中涵盖了 OBIEE 中机器学习的“为什么”,回答了 BI 中最受欢迎的问题:机器学习为什么以及如何成为解决业务问题的完美解决方案，以及如何在 OBIEE 中用于可操作的决策支持？

本章首先概述了一些真实世界的用例，这些用例扩展了第 [3](3.html) 章(预测葡萄酒的起源)中描述的用例。本章详细描述了 OBIEE 中利用机器学习构建高级决策解决方案的一个用例。本章的主要重点是描述所选择的实际用途，以及如何在 OBIEE 中将其与预测葡萄酒原产地的用途结合使用，以构建整体决策解决方案。前面用例的逐步实现细节将在下一章讨论。这种现实世界的决策支持解决方案在提供更好的业务成果和业务价值方面大有可为，并提高了企业竞争情报的标准。

## 真实世界的用例

本节介绍的真实使用案例可以大致分为两大类:

*   预测葡萄酒的起源
*   使用该产地作为预测分析的基础，来预测购买该葡萄酒的倾向

### 预测葡萄酒产地:使用机器学习分类模型

这个用例预测酒的起源。根据每种葡萄酒的等级和其他属性，这些葡萄酒被划分为三个产地之一。预测的输出以 pairs 图的形式绘制，然后与 OBIEE 仪表板集成。

### 使用分类 Win e Origin 作为预测分析的基础——在 OBIEE 中使用机器学习技术扩展 BI

通过使用分类的葡萄酒产地，这个用例预测了购买特定葡萄酒的倾向。这种预测不同于预测葡萄酒产地；现在，我们根据葡萄酒的来源来预测消费者购买葡萄酒的概率。这意味着概率总是介于值 0 和 1 之间，0 表示消费者不会购买(或者更准确地说，不太可能购买)基于其原产地的葡萄酒，1 表示消费者很可能会购买基于其原产地的葡萄酒。注意，在葡萄酒产地预测用例中，输出是三个不同的值:`Origin1`、`Origin2`和`Origin3`。相比之下，此输出是介于 0 和 1 之间的数值小数值，包括 0 和 1。

Note

使用 OBIEE 分析和仪表板中的葡萄酒原产地预测模型和购买倾向模型的输出，业务分析师或 BI 用户可以做出决策，支持采取适当的措施来加快业务流程。通过这种方式，BI 可以扩展到由使用 Oracle 12c 和 OBIEE 中的 R/ORE 的机器学习支持的预测分析领域。

### 使用 BI 仪表板制定可行的决策

OBIEE 决策支持解决方案中预测葡萄酒产地的用例有很多。下面列出了主要的几个:

*   影响购买倾向(如前一小节所述)
*   基于来源预测产量
*   预测葡萄酒的质量
*   推荐用法

您可以使用与 OBIEE 集成的基于 R 的机器学习模型，或者直接使用 OBIEE 进行以下操作:

*   购买倾向可以通过使用称为逻辑回归或广义线性模型(GLM)的机器学习算法来预测。这可以在 OBIEE 中完成，方法是使用内置的回归分析功能，或者使用基于 R 或 ORE 的逻辑回归模型，然后使用概率值来确定结果。
*   预测收益率也可以在 OBIEE 中通过使用过去的购买趋势结合时间序列分析或 Evaluate_Script 分析功能以及基于 SQL 的模型，通过对模型评分来完成。或者可以使用类似于用于预测葡萄酒产地的 R 或 ORE 函数。
*   预测质量可以通过使用基于原点或源预测变量的相同随机森林 ML 模型来完成。
*   推荐使用可以通过使用用于推荐引擎的 ML 算法并将其集成到 OBIEE 仪表板中来完成。

Note

预测购买倾向可以通过以下方式帮助决策支持:

1.  葡萄酒的需求
2.  每个消费者获得的收入和利润
3.  提高葡萄酒质量

## 用例的技术和功能分析

不管业务用例以及所使用的机器学习模型如何，使用 OBIEE 可用于可行决策支持解决方案的基于人工智能的机器学习模型可分为以下步骤:

1.  在 Oracle 中使用 R 构建基于 AI 的机器学习模型。
2.  根据业务数据集对模型进行评分，以获得图形输出或预测分析。
3.  将前面的输出与 OBIEE 集成，以实现可视化和决策支持。这可以是在 OBIEE 或 PNG 输出中利用的基于 SQL 的脚本。
    1.  交互式图形可以基于用户输入的参数或控件来动态驱动。
    2.  SQL 和基于图形的输出的组合可以与 OBIEE 集成。前者可由技术用户用来调整 KPI，和/或后者可由技术/业务用户用来创建提供前瞻性分析的更详细的可视化。 

图 [5-1](#Fig1) 显示了 OBIEE 仪表盘对葡萄酒原产地预测初始用例以及购买倾向用例的可视化。这些可能看起来太简单了，但重要的是要知道，当它们作为交互式或基于 SQL 的控件启用时，它们能够驱动前面步骤中描述的用户操作。

![A439668_1_En_5_Fig1_HTML.jpg](A439668_1_En_5_Fig1_HTML.jpg)

图 5-1。

Dashboard showing the p airs plot of predicting Wine Origin and using it to predict Propensity to Buy based on Wine Origin (Source)

### 图形输出分析:利用随机森林预测葡萄酒产地的 Pairs 图

成对曲线显示了`table(origin_pred, test_set$origin)`的曲线。下面是`table(origin_pred, test_data$origin)`的输出:

```
> table(origin_pred, test_data$origin)
origin_pred Origin1 Origin2 Origin3
    Origin1     140       0       0
    Origin2       0     162       0
    Origin3       0       0     111

```

这是对 R 中 pairs 图的调用:

```
pairs(table(origin_pred, test_set$origin), main="Wine Origin Predictors")

```

响应变量以对角线形式书写，从左上到右下。这些是结果`Origin1`、`Origin2`和`Origin3`。然后将每个变量与另一个相对照。这里我们用一个`table`(或矩阵)输出绘制了`origin_pred`的值和`test_data$origin`的值。第一列中间的图是`Origin1`对`Origin2`的单对图，同样在`table`输出中。这对应于上表输出中的第一行。

在顶部中间行中复制了相同的绘图。如您所见，这对应于上表中的第二行。左上角没有数据，因为它只是一条绘制原点对原点的直对角线，而不是`origin_pred`对`origin`。

可以类似地分析其他单独的图，以对应于前面表格输出中的适当行。

### 图形输出分析:基于葡萄酒来源预测购买倾向

`ggplot`是属于`ggplot2` R 库的图形可视化函数。使用`ggplot`，图形或绘图由以下内容组成:

数据+美学+几何

这里的数据是一个 R 数据帧。美观表示 x 和 y 变量和/或绘图元素(点、线、带、条等)的类型、颜色和大小。).几何图形是绘图的类型；示例包括点图、线图、条形图、带状图、箱形图和密度图。创建自定义绘图的主要功能是`ggplot()`，它允许点、线、带等的组合。参数组在这里很重要。`ggplot`调用的规范在 y 轴上设置了带有响应变量的图形画布。

Note

在 [`www.r-bloggers.com/part-3a-plotting-with-ggplot2/`](https://www.r-bloggers.com/part-3a-plotting-with-ggplot2/) 中可以找到关于`ggplot`及其函数调用、签名和示例的很好的介绍。

下面是对我们的示例用例中使用的`ggplot()`函数的调用，该函数根据葡萄酒来源绘制购买倾向预测:

```
library(ggplot2)
gg_plot <- ggplot(data=test_set, aes(x=Source, y=p_to_buyPred, group=1)) +
geom_line(aes(colour = p_to_buyPred), size = 1) + geom_point() +
stat_smooth(method="glm", family="binomial", se=FALSE) +
ggtitle("Predicting Propensity to buy based on Wine Source") +
labs(x="Source", y="Predicted Probability - p_to_buyPred")
plot(gg_plot)

```

Note

`geom_line`和`stat_smooth`连接属于同一组的数据点。通过指定`group=1`，我们告诉`ggplot`所有数据点都属于 group = 1。因此，我们得到一条单一的(V 形)线，将由`geom_point()`绘制的三个数据点连接在一起。此外，回归线，如下所述，也出现在图中。

对`geom_line()`的调用包括`colour=p_to_buyPred`，表示线条颜色由`p_to_buyPred`变量的级别(预测概率)自动控制；`size = 1`表示线尺寸为 1 个单位。`aes`如前所述，代表线条的美感。`stat_smooth()`功能基于使用`link = "binomial"`的 GLM 模型对原始数据的转换，在`geom_line`和`geom_point`几何图形上生成并拟合一条平滑线(回归线或最佳拟合线)。这也称为绘制回归斜率。这是作为参数`method = "glm"`、`family="binomial"`传递的。参数`se`指示是否显示要使用的置信区间(默认为 0.95)。。`method`参数是要使用的平滑方法(在本代码中指定为`glm,`，因为我们使用了逻辑回归模型)，而`formula`是平滑函数中要使用的公式。平滑功能有助于识别何时发生过度绘制。在图 [5-1](#Fig1) 中，这显示为剖切 V 形线的图中间的线。

不带任何参数调用`geom_point()`意味着使用默认的点形状(点)和颜色(黑色)。这个函数调用绘制实际的数据点。

`ggtitle`打印参数中给出的图的标题。`labs`表示图的 x 轴和 y 轴标签，分别为`"Source"`和`"Predicted Probability - p_to_buyPred"`。可以通过更改对应于 alpha、颜色、线型和大小的参数来自定义 ggplot。

### 更详细的分析

在更详细的层面上，可以通过使用带有`geom_ribbon()`几何图形的带状图来进一步分析购买倾向的用例。我们首先从采采蝇数据集(通过采样`Wineptobuy.csv`文件中的原始数据获得)中省略`propensity_to_buy`列来获得测试数据。我们将这些数据加载到称为`test_set2`的数据帧中。然后，我们用`test_set2`来推导`test_set3`。清单 [5-1](#Par48) 显示了这个分析的完整代码。

```
library(ORE)
ore.connect("testr","orcl","localhost","testr")
library(OREmodels)
# The file Wineptobuy.csv is assumed to be in the working directory from # where the ORE CLI is called
winedata <- read.csv("Wineptobuy.csv", header=TRUE, row.names = NULL, sep=',') # loads input data into R data frame
head(winedata) # Displays 6 rows of data in the data frame winedata
summary(winedata) # Gives a statistical summary of the data in winedata data # frame
sapply(winedata, sd) # Applies the standard deviation sd function to each # variable in the data set winedata# The below two lines display a two-way contingency table of response # variable propensity_to_buy and the predictors
# Source and origin respectively to ensure there are not any any 0 cells in # the winedata data set. In other words,
# xtabs function displays the frequency or count of the levels of # categorical variables as matrix or table - a
# cross-tabulation, revealing the relationship between propensity_to_buy and # Source; and between propensity_to_buy
# and origin.
xtabs(∼propensity_to_buy +Source, data=winedata)
xtabs(∼propensity_to_buy +origin, data=winedata)
label <- winedata[,23]
head(label)
library(caTools) 

s <- sample.split(label, SplitRatio=3/4) # Derives a sample split s based on # split ratio of 0.75
train_set <- winedata[s, c(2:20, 23)] # Samples the input data into train_# set (columns 2-20, and 23) based on s
test_set <- winedata[!s, c(2:20, 23)] # Samples the data not in train_set # into test_set
head(train_set) # Displays 6 rows of the train_set
nrow(train_set) # Displays count of rows in train set
head(test_set) # Displays 6 rows of the test set
nrow(test_set) # Displays count of rows in test set
# Loads a matrix of Source and propensity_to_buy columns in train_set into # sp.tab
sp.tab <- table(train_set$Source, train_set$propensity_to_buy)
sp.tab # Display the above matrix
train_set$Source <- factor(train_set$Source) # This treats source as a # categorical variable
# Builds a Logistic Regression Model in R using 'glm' Machine Learning # algorithm with response variable as
# propensity_to_buy and predictor variable as Source using the train_set # data set. The family function for the
# glm model is "binomial" (indicating that the model is a binomial model) # and the link is logit), and the maximum
# iterations to be performed is 100
logitM <- glm(propensity_to_buy ∼ Source, data = train_set, family="binomial", control = glm.control(maxit=100))
# Displays a summary of the logitM model just built in terms of the function # call for glm; the deviance residuals
# (Min, 1st Quantile, Median, 3rd Quantile, and the Max) which are a measure # of the model fit or in other words the
# distribution of of the deviance residuals for observations used in the # model; the table of coefficients with the
# coefficients, their standard errors, the z-statistic or the Wald # Z-statistic, and the associated p-values
# displayed across, and the Intercept and the predictor variables displayed # down the matrix; the fit indices which
# include the null deviance and residual deviance and the AIC (Akaike # Information Criteria). A model with minumum
# AIC value is considered to fit without penalty for the model coefficients. 

summary(logitM)
anova(logitM)
# install.packages("aod")
# The wald.test function tests for the Chi-squared test statistic based on # the coeffieicents of the logitM model. In
# our case we can test the significance of Source predictor variable using # this function from the aod library of R.
# The order of the model coefficients in the table of coefficients is same # as the order of terms in the model. This
# is relevant since the wald.test function refers to their coefficients by # their order in the model. In the below
# three wald.test calls, the argument b passes the coefficients, Sigma gives # the variance and covariance matrix of
# the error terms, and Terms indicates which terms in the model are to be # tested. In our use case these are the
# terms 2 and 3\. Also, running the function wald.test for Terms 1 and 2; and # 1,2 and 3 in addition to terms 2 and 3
# gives a chi-squared test statistic with degress of freedom 2, 3 and 2 # respectively and the p-value of 1.0 in all three cases thereby showing that # Source is statistically significant.
library(aod)
wald.test(b = coef(logitM), Sigma = vcov(logitM), Terms =  1:2)
wald.test(b = coef(logitM), Sigma = vcov(logitM), Terms =  1:3)
wald.test(b = coef(logitM), Sigma = vcov(logitM), Terms =  2:3)
# The exp function below exponentiates the coefficients and analyzes them as # odds-ratios.
exp(coef(logitM)) 

head(test_set) # Displays 6 rows of the test_set data set
nrow(test_set) # Displays number of rows in test_set
head(data.frame(test_set[,c(1:19)])) # Displays 6 rows of columns 1 to 19 in # test_set
nrow(data.frame(test_set[,c(1:19)])) # Displays count of rows taking columns # 1 to 19 in test_set
# Uses the predict() function in R to do a prediction of propensity to buy # on a new data set which consists of
# all rows and columns 1 to 19 in test_set indicating that the values of the # predictor variables are from this
# test_set and that the values of test_set$p_to_buyPred must be predictions # using predict(). This is called scoring

# the model. The type of response is response and means the type of # prediction is a predicted probability as opposed
# to an actual value.
# Note that the original column propensity_to_buy is eliminated in the new # data set (test_set) while scoring model.
# It outputs a set of probabilities (as opposed to actual values) that fall # in the closed interval [0,1].
# These probabilities are stored in a newly created column p_to_buyPred in # the test_set.
test_set$p_to_buyPred <- predict(logitM,  newdata = data.frame(test_set[,c(1:19)]), type="response")
class(test_set$p_to_buyPred) # Shows the R class of test_set$p_to_buyPred
head(test_set) # Displays 6 rows of test_set which includes the newly # created column p_to_buyPred
test_set$p_to_buyPred <- ifelse(test_set$p_to_buyPred > 0.5,1,0) # Quantifies probabilities into values 1 and 0
misClasificError <- mean(test_set$p_to_buyPred != test_set$propensity_to_buy) # Displays misclassification error
print(paste('Accuracy',1-misClasificError)) # Displays the accuracy if the # model built and scored. 

# An accuracy approaching 1 is considered optimal.
# The library ROCR is used to load the R functions for plotting the Reciever # Operating Characteristic (ROC). ROC  
# summarizes the performance of the model by evaluating the cross-# correlation between true +ve rate or sensitivity
# and false -ve rate or (1-specificity). Keeping p>0.5, ROC summarizes the # prediction for all possible values of
# p>0.5\. The area under curve (AUC) is an optimal performance metric for ROC # and the higher value of AUC, the better
# the #prediction of the glm model.
# This package enables visualizing the performance of scoring classifiers # using the prediction, performance and plot
# functions. Its definition can be found at http://rocr.bioinf.mpi-sb.mpg.# de/
library(ROCR)
class(test_set$p_to_buyPred) # Displays the R class of the predicted value # p_to_buyPred of test_set
# Used the R prediction() function of GLM to transform the input data # containing predictions into a standard format
# Here it transforms two columns of data given by p_to_buyPred (predictions) # and propensity_to_buy into a standard
# format and returns an object of class prediction.
pr1 <- prediction(test_set$p_to_buyPred, test_set$propensity_to_buy)
class(pr1) # This gives "prediction" as the class
# The performance function is used to do a predictor evaluation. Its # signature is 

# performance(prediction.obj, measure, x.measure). It works on a prediction # object (pr1 in this case),
# and measure is performance measure to used for evaluation ("tpr" or the # true positive rate in this case), and
# x.measure is a second performance measure ("fpr" or false positive rate). # The measure is plotted in y-axis and the
# x.measure is plotted in the x-axis to result in a 2D curve. Other measures # can also be passed such as "auc" (area
# under ROC), "acc" (accuracy), "err" (Error rate) etc.
prf1 <- performance(pr1, measure = "tpr", x.measure = "fpr")
class(prf1) # This gives "performance" as the classpdf("plot_prf1.pdf") # This saves the plotted graph as a PDF file in the working directory
# This plots  an object of class performance, in our case, prf1\. colorize # specifies whether the curve is to be
# colorized according to cutoff.
plot(prf1, colorize = TRUE) # , text.adj = c(-0.2,1.7)
dev.off()

# This makes a different call to performance() function with the measure to # be evaluated as "auc" or area under ROC
# curve. This returns the performance of the above prediction with "auc" as # the evaluation measure. Auc is the area
# under ROC curve.
auc1 <- performance(pr1, measure = "auc")
auc1 <- auc1@y.values[[1]]
auc1 # "auc" closer to 1 or equaling 1 indicates a goodness of fit and a # better prediction performance of the model
library(ROCR)
p <- predict(logitM, newdata= data.frame(test_set[,c(1:19)]), type="response")
class(p)
pr <- prediction(p, test_set$propensity_to_buy)
class(pr)
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
class(prf)
plot(prf, colorize = TRUE) # , text.adj = c(-0.2,1.7)
auc <- performance(pr, measure = "auc")
auc <- auc@y.values[[1]]
auc
test_set2 <- data.frame(test_set[,c(1:19)])
head(test_set2)
# The within R function uses the test_set3 data set as its argument and # generates a data.frame that is used for the
# ribbon layer data. The very first line inside the within generates the # predicted probabilities along with the
# standard errors that aid in plotting a confidence interval. The argument # se is specified to indicate whether to
# display confidence interval to use (0.95 by default) and also enables to # plot a confidence interval. The
# type="link" gives the estimates on the link scale.
# The remaining lines back transform both the predicted values and # confidence intervals into probabilities.
# The cbind does a column-wise bind of the data frame test_set2 with the # predicted outcome column scored by
# the predict function that is passed as the second argument to cbind. For # logistic regression model, the confidence
# intervals are based on the profiled log-likelihood function. The lower and # upper indicate the lower and upper
# confidence limits. 

test_set3 <- cbind(test_set2, predict(logitM, newdata=test_set2, type = "link", se = TRUE))
test_set3 <- within(test_set3, {
PredictedProb <- plogis(fit)
lower <- plogis(fit - (1.96 * se.fit))
upper <- plogis(fit + (1.96 * se.fit))
})

head(test_set3)

library(ggplot2)

pdf("test_set3_ribbon.pdf") # The below line sets up the graph canvas with # response variable on y-axis

ggplot(test_set3, aes(x = Source, y = PredictedProb, group=PredictedProb)) +

geom_line(aes(colour = PredictedProb), size = 1) + geom_point() + # Plots # the actual data points

geom_ribbon(aes(ymin = lower, ymax = upper, fill = PredictedProb), alpha = 0.25) + # alpha fades out connect lines

scale_fill_gradient(low="red", high="green") + # Defines a continuous color # scale for the ribbon layer

ggtitle("Predicting Propensity to buy based on Wine Source") + # Title of # the final plot

ylab("Predicted Probability - p_to_buyPred") # Specify label for y-axis. # This also serves as the graph legend

dev.off()

Listing 5-1.Code for Further Analyzing the Use Case of propensity_to_buy

```

`scale_fill_gradient()`功能用于定义连续色标。在我们的例子中，高概率值用绿色填充，低概率值用红色填充。该图是一个带状图(连续),因此添加`scale_fill_gradient()`层会使其成为一个带有彩色带状填充的连续刻度——绿色表示高，红色表示低。

清单 [5-1](#Par48) 中的以下代码段与我们进一步分析的讨论相关:

```
test_set3 <- cbind(test_set2, predict(logitM, newdata=test_set2, type = "link", se = TRUE))
test_set3 <- within(test_set3, {
PredictedProb <- plogis(fit)
lower <- plogis(fit - (1.96 * se.fit))
upper <- plogis(fit + (1.96 * se.fit))
})
head(test_set3)

```

下面是代码的解释:

为了查看`test_set2`中的内容，我们在命令行中运行`head(test_set2)` R 命令来获得以下输出:

```
> head(test_set2)
   origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
1 Origin1     1   14.22       1.70 2.30              16.3       118
2 Origin1     1   14.10       2.16 2.30              18.0       105
3 Origin1     1   14.12       1.48 2.32              16.8        95
4 Origin1     1   14.21       4.04 2.44              18.9       111
5 Origin1     1   13.05       1.73 2.04              12.4        92
6 Origin1     1   13.77       1.90 2.68              17.1       115
  Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins Color.intensity
1        3.20     3.00               0.26            2.03            6.38
2        2.95     3.32               0.22            2.38            5.75
3        2.20     2.43               0.26            1.57            5.00
4        2.85     2.65               0.30            1.25            5.24
5        2.72     3.27               0.17            2.91            7.20
6        3.00     2.79               0.39            1.68            6.30
   Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2 Origin3  Source

1 0.94                         3.31     970   1.000   0.000       0 Origin1
2 1.25                         3.17    1510   1.000   0.000       0 Origin1
3 1.17                         2.82    1280   1.000   0.000       0 Origin1
4 0.87                         3.33    1080   0.996   0.004       0 Origin1
5 1.12                         2.91    1150   1.000   0.000       0 Origin1
6 1.13                         2.93    1375   1.000   0.000       0 Origin1
>

```

最后一列`Source`给出了使用随机森林算法预测的葡萄酒原产地，其输出显示为 pairs 图。我们看到，当`Origin1`和`Origin3`的值等于 1 或几乎接近 1 时，源被预测为`Origin1`。当`Origin2`栏中的值为 0 或接近 0 时，`Source`为`Origin2`。

`within` R 函数使用`test_set3`数据集作为其参数，并生成用于带状层数据的数据框。

上述代码的第一行生成预测概率以及标准误差，有助于绘制置信区间。`type="link"`给出了链路规模的估计值。剩余的行将预测值和置信区间反转换成概率。

为了查看`test_set3`的输出，我们运行`head(test_set3)`命令得到以下输出:

```
> head(test_set3)
   origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
1 Origin1     1   14.22       1.70 2.30              16.3       118
2 Origin1     1   14.10       2.16 2.30              18.0       105
3 Origin1     1   14.12       1.48 2.32              16.8        95
4 Origin1     1   14.21       4.04 2.44              18.9       111
5 Origin1     1   13.05       1.73 2.04              12.4        92
6 Origin1     1   13.77       1.90 2.68              17.1       115
  Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins Color.intensity
1         3.20       3.00               0.26            2.03            6.38
2         2.95       3.32               0.22            2.38            5.75
3         2.20       2.43               0.26            1.57            5.00
4         2.85       2.65               0.30            1.25            5.24
5         2.72       3.27               0.17            2.91            7.20
6         3.00       2.79               0.39            1.68            6.30
   Hue OD280.OD31

5.of.diluted.wines Proline Origin1 Origin2 Origin3  Source
1 0.94                         3.31     970   1.000   0.000       0 Origin1
2 1.25                         3.17    1510   1.000   0.000       0 Origin1
3 1.17                         2.82    1280   1.000   0.000       0 Origin1
4 0.87                         3.33    1080   0.996   0.004       0 Origin1
5 1.12                         2.91    1150   1.000   0.000       0 Origin1
6 1.13                         2.93    1375   1.000   0.000       0 Origin1
       fit   se.fit residual.scale upper lower PredictedProb

1 28.56607 94471.71              1     1     0             1

2 28.56607 94471.71              1     1     0             1

3 28.56607 94471.71              1     1     0             1

4 28.56607 94471.71              1     1     0             1

5 28.56607 94471.71              1     1     0             1

6 28.56607 94471.71              1     1     0             
1

```

Note

列`fit`、`se.fit`、`residual.scale`、`upper`、`lower`和`PredictedProb`给出了适合度、适合的标准误差、残差尺度、预测值以及置信上限和置信下限以及预测概率。置信区间在 95%的水平。

然后，我们使用与`geom_line()`和`geom_point()`耦合的`geom_ribbon()`几何函数，如清单 [5-2](#Par62) 所示，以得到图 [5-2](#Fig2) 所示的带状图。将`ggplot`与`geom_ribbon()`结合使用，您可以绘制一个带有预测概率和 95%置信区间的图表。这在对`geom_ribbon()`的调用中显而易见，其中使用置信限的下限值和上限值给出了美感(在清单 [5-1](#Par48) 中以粗体显示的代码行中)。清单 [5-1](#Par48) 中的以下代码段显示了这一点:

```
library(ggplot2)
pdf("test_set3_ribbon.pdf")
ggplot(test_set3, aes(x = Source, y = PredictedProb, group=PredictedProb)) +
geom_line(aes(colour = PredictedProb), size = 1) + geom_point() +
geom_ribbon(aes(ymin = lower, ymax = upper, fill = PredictedProb), alpha = 0.25)  +
scale_fill_gradient(low="red", high="green") +
ggtitle("Predicting Propensity to buy based on Wine Source") +
ylab("Predicted Probability - p_to_buyPred")
dev.off()

```

主图是通过将美学指定为 x 轴的葡萄酒`Source`和 y 轴的`PredictedProb`(从清单 [5-1](#Par48) 中获得)获得的 gg 图，它们由`PredictedProb`本身分组。这被绘制为连接原点 1 和原点 3 的两点的单线，因为这些点对应于值 1 的概率。色带层本身用绿色绘制，由`fill = PredictedProb`和对具有`low="red"`和`high="green"`的`scale_fill_gradient()`函数的调用指定。当`PredictedProb`的最大值为 1 时，色带的填充颜色为绿色，而`Origin2`的红色被图层本身所掩盖。作为图表的一部分，`geom_line()`和`geom_ribbon()`的测量刻度或图例出现在色带和线条旁边。alpha 值给出了带状图的透明度级别。`scale_fill_gradient()`与`geom_ribbon()`配对，形成图 [5-2](#Fig2) 中的复合图形。整个图以 PDF 格式保存为图像文件。

![A439668_1_En_5_Fig2_HTML.jpg](A439668_1_En_5_Fig2_HTML.jpg)

图 5-2。

test_set3_ribbon.pdf (ribbon plot of test_set for p redicted probilities)

```
g <- ggplot(test_set3, aes(x = Source, y = PredictedProb, group=PredictedProb)) +
geom_line(aes(colour = PredictedProb), size = 1) + geom_point() +
geom_ribbon(aes(ymin = lower, ymax = upper, fill = PredictedProb), alpha = 0.25)  +
scale_fill_gradient(low="red", high="green") +
ggtitle("Predicting Propensity to buy based on Wine Source") +
ylab("Predicted Probability - p_to_buyPred")

```

### 预测购买倾向的用例

我们可以使用多层带状几何图形来构建一个图表，描绘决策制定的方式。通过将清单 [5-2](#Par62) 中所示的代码添加到清单 [5-1](#Par48) 中的代码示例中，我们可以显示功能区上方和下方的区域，进而帮助做出决策。执行该代码的结果如图 [5-3](#Fig3) 所示。

![A439668_1_En_5_Fig3_HTML.jpg](A439668_1_En_5_Fig3_HTML.jpg)

图 5-3。

Graph showing areas below and above the ribbon plot (based on use case of propensity to buy)

```
library(ggplot2)
g <- ggplot(test_set3, aes(x = Source, y = PredictedProb, group=PredictedProb)) +
geom_line(aes(colour = PredictedProb), size = 1) + geom_point() +
geom_ribbon(aes(ymin = lower, ymax = upper, fill = PredictedProb), alpha = 0.25)
# The ggplot_build function returns a list of data frames (one for each # layer) and a panel object with information
# about the actual x- and y- axis ranges for plot in context. In our case # this is ribbon plot
res <- ggplot_build(g)

bottom <- res[[2]]$panel_ranges[[1]]$y.range[1] # This sets the floor y-axis # plot range for ggplot2 (ribbon plot)

top    <- res[[2]]$panel_ranges[[1]]$y.range[2] # This sets the ceil y-axis # plot range ffor ggplot2 (ribbon plot)

ggplot(test_set3, aes(x = Source, y = PredictedProb, group=PredictedProb)) +
geom_ribbon(aes(ymin = lower, ymax = upper, fill = PredictedProb), alpha=0.25) + # layer for the ribbon
geom_ribbon(aes(ymin=bottom, ymax=lower), fill="red", alpha=0.25) + # layer # below the ribbon
geom_ribbon(aes(ymin=upper, ymax=top), fill="green", alpha=0.25) + # layer # above the ribbon
geom_point() + geom_line()

Listing 5-2.
Code Segment

for Adding Multiple Areas Below and Above the Ribbon Layer

```

在上图中，我们可以看到红色区域代表原产地葡萄酒 2 的使用案例，该葡萄酒的需求较低`.`,因此我们可以推断，要么葡萄酒的质量需要提高，要么生产来源需要更加集中。

然而，色带上方的绿色区域表明来自`Origin1`和`Origin3`的葡萄酒的需求和供应都很高。因此，来自这些来源的葡萄酒的收入和利润也很高。

当此输出与 OBIEE 集成时，通过提供用户可以利用来实现业务决策支持的控制(如参数和操作过滤器),可以使前面的结论具有可操作性。

下面是清单 [5-1](#Par48) 和 [5-2](#Par62) 中代码组合的输出:

```
> ore.connect("testr","orcl","localhost","testr")
> library(OREmodels)
> winedata <- read.csv("Wineptobuy.csv", header=TRUE, row.names = NULL, sep=',$
> head(winedata)
  id  origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
1  1 Origin1     1   14.37       1.95 2.50              16.8       113
2  2 Origin1     1   14.20       1.76 2.45              15.2       112
3  3 Origin1     1   14.06       2.15 2.61              17.6       121
4  4 Origin1     1   13.64       3.10 2.56              15.2       116
5  5 Origin1     1   14.06       1.63 2.28              16.0       126
6  6 Origin1     1   12.85       1.60 2.52              17.8        95
  Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins Color.intensity
1          3.85       3.49              0.24            2.18            7.80
2          3.27       3.39              0.34            1.97            6.75
3          2.60       2.51              0.31            1.25            5.05
4          2.70       3.03              0.17            1.66            5.10
5          3.00       3.17              0.24            2.10            5.65
6          2.48       2.37              0.26            1.46            3.93
   Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2 Origin3  Source

1 0.86                         3.45    1480   1.000   0.000   0.000 Origin1
2 1.05                         2.85    1450   0.994   0.004   0.002 Origin1
3 1.06                         3.58    1295   1.000   0.000   0.000 Origin1
4 0.96                         3.36     845   1.000   0.000   0.000 Origin1
5 1.09                         3.71     780   1.000   0.000   0.000 Origin1
6 1.09                         3.63    1015   1.000   0.000   0.000 Origin1
  origin.1 id.1 propensity_to_buy
1  Origin1    1                 1
2  Origin1    2                 1
3  Origin1    3                 1
4  Origin1    4                 1
5  Origin1    5                 1
6  Origin1    6                 1
> summary(winedata)
       id          origin        class         Alcohol        Malic.acid
 Min.   :  1   Origin1:140   Min.   :1.00   Min.   :11.03   Min.   :0.740
 1st Qu.:104   Origin2:162   1st Qu.:1.00   1st Qu.:12.37   1st Qu.:1.530
 Median :207   Origin3:111   Median :2.00   Median :13.05   Median :1.830

 Mean   :207                 Mean   :1.93   Mean   :13.00   Mean   :2.343
 3rd Qu.:310                 3rd Qu.:3.00   3rd Qu.:13.67   3rd Qu.:3.100
 Max.   :413                 Max.   :3.00   Max.   :14.75   Max.   :5.800
      Ash        Alcanility.of.ash   Magnesium      Total.phenols
 Min.   :1.360   Min.   :10.60     Min.   : 70.00   Min.   :0.980
 1st Qu.:2.210   1st Qu.:17.00     1st Qu.: 89.00   1st Qu.:1.740
 Median :2.360   Median :19.00     Median : 97.00   Median :2.230
 Mean   :2.366   Mean   :19.43     Mean   : 99.58   Mean   :2.276
 3rd Qu.:2.580   3rd Qu.:21.50     3rd Qu.:107.00   3rd Qu.:2.800
 Max.   :3.230   Max.   :30.00     Max.   :162.00   Max.   :3.880
   Flavanoids    Nonflavanoid.phenols Proanthocyanins Color.intensity
 Min.   :0.340   Min.   :0.1300       Min.   :0.410   Min.   : 1.280
 1st Qu.:1.200   1st Qu.:0.2700       1st Qu.:1.140   1st Qu.: 3.300
 Median :2.140   Median :0.3400       Median :1.460   Median : 4.600
 Mean   :2.011   Mean   :0.3658       Mean   :1.538   Mean   : 4.934
 3rd Qu.:2.780   3rd Qu.:0.4500       3rd Qu.:1.870   3rd Qu.: 5.850
 Max.   :5.080   Max.   :0.6600       Max.   :3.580   Max.   :13.000
      Hue         OD280.OD315.of.diluted.wines    Proline
 Min.   :0.5400   Min.   :1.270                Min.   : 278.0
 1st Qu.:0.7600   1st Qu.:1.830                1st Qu.: 510.0
 Median :0.9600   Median :2.780                Median : 678.0
 Mean   :0.9618   Mean   :2.587                Mean   : 749.5
 3rd Qu.:1.1300   3rd Qu.:3.140                3rd Qu.: 985.0
 Max.   :1.7100   Max.   :4.000                Max.   :1680.0
    Origin1         Origin2         Origin3           Source       origin.1
 Min.   :0.0000  Min.   :0.0000  Min.   :0.0000   Origin1:140    Origin1:140

 1st Qu.:0.0000  1st Qu.:0.0000  1st Qu.:0.0000   Origin2:162    Origin2:162
 Median :0.0000  Median :0.0020  Median :0.0000   Origin3:111    Origin3:111
 Mean   :0.3395   Mean   :0.3922   Mean   :0.2683
 3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.:0.9760
 Max.   :1.0000   Max.   :1.0000   Max.   :1.0000
      id.1     propensity_to_buy
 Min.   :  1   Min.   :0.0000
 1st Qu.:104   1st Qu.:0.0000
 Median :207   Median :1.0000
 Mean   :207   Mean   :0.6077
 3rd Qu.:310   3rd Qu.:1.0000
 Max.   :413   Max.   :1.0000
> sapply(winedata, sd)
                          id                       origin
                 119.3670809                    0.7773550
                       class                      Alcohol
                   0.7773550                    0.7667311
                  Malic.acid                          Ash
                   1.1720914                    0.2931987
           Alcanility.of.ash                    Magnesium
                   3.4096871                   14.2594176
               Total.phenols                   Flavanoids
                   0.6270436                    0.9700433
        Nonflavanoid.phenols              Proanthocyanins

                   0.1293551                    0.5520653
             Color.intensity                          Hue
                   2.1460253                    0.2289449
OD280.OD315.of.diluted.wines                      Proline
                   0.7162199                  311.4138632
                     Origin1                      Origin2
                   0.4731436                    0.4869368
                     Origin3                       Source
                   0.4421105                    0.7773550
                    origin.1                         id.1
                   0.7773550                  119.3670809
           propensity_to_buy
                   0.4888445
> xtabs(∼propensity_to_buy +Source, data=winedata)
                 Source
propensity_to_buy Origin1 Origin2 Origin3
                0       0     162       0
                1     140       0     111
> xtabs(∼propensity_to_buy +origin, data=winedata)
                 origin
propensity_to_buy Origin1 Origin2 Origin3
                0       0     162       0
                1     140       0     111
> label <- winedata[,23] 

> head(label)
[1] 1 1 1 1 1 1
> library(caTools)
Warning message:
package 'caTools' was built under R version 3.2.5
> s <- sample.split(label, SplitRatio=3/4)
> train_set <- winedata[s, c(2:20, 23)]
> test_set <- winedata[!s, c(2:20, 23)]
> head(train_set)
   origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
1 Origin1     1   14.37       1.95 2.50              16.8       113
3 Origin1     1   14.06       2.15 2.61              17.6       121
4 Origin1     1   13.64       3.10 2.56              15.2       116
6 Origin1     1   12.85       1.60 2.52              17.8        95
7 Origin1     1   13.87       1.90 2.80              19.4       107
9 Origin1     1   13.51       1.80 2.65              19.0       110
  Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins Color.intensity

1          3.85       3.49              0.24            2.18            7.80
3          2.60       2.51              0.31            1.25            5.05
4          2.70       3.03              0.17            1.66            5.10
6          2.48       2.37              0.26            1.46            3.93
7          2.95       2.97              0.37            1.76            4.50
9          2.35       2.53              0.29            1.54            4.20
   Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2 Origin3  Source
1 0.86                         3.45    1480   1.000   0.000       0 Origin1
3 1.06                         3.58    1295   1.000   0.000       0 Origin1
4 0.96                         3.36     845   1.000   0.000       0 Origin1
6 1.09                         3.63    1015   1.000   0.000       0 Origin1
7 1.25                         3.40     915   0.996   0.004       0 Origin1
9 1.10                         2.87    1095   1.000   0.000       0 Origin1
  propensity_to_buy
1                 1
3                 1
4                 1
6                 1
7                 1
9                 1
> nrow(train_set)
[1] 310
> head(test_set) 

    origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
2  Origin1     1   14.20       1.76 2.45              15.2       112
5  Origin1     1   14.06       1.63 2.28              16.0       126
8  Origin1     1   13.73       1.50 2.70              22.5       101
10 Origin1     1   13.05       1.65 2.55              18.0        98
11 Origin1     1   13.88       1.89 2.59              15.0       101
18 Origin1     1   13.74       1.67 2.25              16.4       118
   Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins
2           3.27       3.39                 0.34            1.97
5           3.00       3.17                 0.24            2.10
8           3.00       3.25                 0.29            2.38
10          2.45       2.43                 0.29            1.44
11          3.25       3.56                 0.17            1.70
18          2.60       2.90                 0.21            1.62
   Color.intensity  Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2

2             6.75 1.05                         2.85    1450   0.994   0.004
5             5.65 1.09                         3.71     780   1.000   0.000
8             5.70 1.19                         2.71    1285   0.998   0.002
10            4.25 1.12                         2.51    1105   1.000   0.000
11            5.43 0.88                         3.56    1095   0.996   0.002
18            5.85 0.92                         3.20    1060   1.000   0.000
   Origin3  Source propensity_to_buy
2    0.002 Origin1                 1
5    0.000 Origin1                 1
8    0.000 Origin1                 1
10   0.000 Origin1                 1
11   0.002 Origin1                 1
18   0.000 Origin1                 1
> nrow(test_set)
[1] 103
> sp.tab <- table(train_set$Source, train_set$propensity_to_buy)
> sp.tab

            0   1
  Origin1   0  98
  Origin2 122   0
  Origin3   0  90
> train_set$Source <- factor(train_set$Source)
> logitM <- glm(propensity_to_buy ∼ Source, data = train_set, family="binomial$
> summary(logitM)

Call:
glm(formula = propensity_to_buy ∼ Source, family = "binomial",
    data = train_set, control = glm.control(maxit = 100))

Deviance Residuals:
       Min          1Q      Median          3Q         Max
-8.861e-07  -8.861e-07   8.861e-07   8.861e-07   8.861e-07

Coefficients: 

                Estimate Std. Error z value Pr(>|z|)
(Intercept)    2.857e+01  9.779e+04       0        1
SourceOrigin2 -5.713e+01  1.313e+05       0        1
SourceOrigin3  1.838e-05  1.413e+05       0        1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4.1559e+02  on 309  degrees of freedom
Residual deviance: 2.4340e-10  on 307  degrees of freedom
AIC: 6

Number of Fisher Scoring iterations: 27

> anova(logitM) 

Analysis of Deviance Table

Model: binomial, link: logit

Response: propensity_to_buy

Terms added sequentially (first to last)

       Df Deviance Resid. Df Resid. Dev
NULL                     309     415.59
Source  2   415.59       307       0.00
> # install.packages("aod")
> library(aod)
Warning message: 

package 'aod' was built under R version 3.2.5
> wald.test(b = coef(logitM), Sigma = vcov(logitM), Terms =  1:2)
Wald test:
----------

Chi-squared test:
X2 = 1.9e-07, df = 2, P(> X2) = 1.0
> wald.test(b = coef(logitM), Sigma = vcov(logitM), Terms =  1:3)
Wald test:
----------

Chi-squared test:
X2 = 2.7e-07, df = 3, P(> X2) = 1.0
> wald.test(b = coef(logitM), Sigma = vcov(logitM), Terms =  2:3)
Wald test:
----------

Chi-squared test: 

X2 = 2.6e-07, df = 2, P(> X2) = 1.0
> exp(coef(logitM))
  (Intercept) SourceOrigin2 SourceOrigin3
 2.547343e+12  1.541085e-25  1.000018e+00
> head(test_set)
    origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
2  Origin1     1   14.20       1.76 2.45              15.2       112
5  Origin1     1   14.06       1.63 2.28              16.0       126
8  Origin1     1   13.73       1.50 2.70              22.5       101
10 Origin1     1   13.05       1.65 2.55              18.0        98
11 Origin1     1   13.88       1.89 2.59              15.0       101
18 Origin1     1   13.74       1.67 2.25              16.4       118
   Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins
2           3.27       3.39                 0.34            1.97
5           3.00       3.17                 0.24            2.10
8           3.00       3.25                 0.29            2.38
10          2.45       2.43                 0.29            1.44
11          3.25       3.56                 0.17            1.70
18          2.60       2.90                 0.21            1.62
   Color.intensity  Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2

2             6.75 1.05                         2.85    1450   0.994   0.004
5             5.65 1.09                         3.71     780   1.000   0.000
8             5.70 1.19                         2.71    1285   0.998   0.002
10            4.25 1.12                         2.51    1105   1.000   0.000
11            5.43 0.88                         3.56    1095   0.996   0.002
18            5.85 0.92                         3.20    1060   1.000   0.000
   Origin3  Source propensity_to_buy
2    0.002 Origin1                 1
5    0.000 Origin1                 1
8    0.000 Origin1                 1
10   0.000 Origin1                 1
11   0.002 Origin1                 1
18   0.000 Origin1                 1
> nrow(test_set)
[1] 103
> head(data.frame(test_set[,c(1:19)]))
   origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium

1 Origin1     1   14.20       1.76 2.45              15.2       112
2 Origin1     1   14.06       1.63 2.28              16.0       126
3 Origin1     1   13.73       1.50 2.70              22.5       101
4 Origin1     1   13.05       1.65 2.55              18.0        98
5 Origin1     1   13.88       1.89 2.59              15.0       101
6 Origin1     1   13.74       1.67 2.25              16.4       118
  Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins Color.intensity
1          3.27       3.39              0.34            1.97            6.75
2          3.00       3.17              0.24            2.10            5.65
3          3.00       3.25              0.29            2.38            5.70
4          2.45       2.43              0.29            1.44            4.25
5          3.25       3.56              0.17            1.70            5.43
6          2.60       2.90              0.21            1.62            5.85
   Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2 Origin3  Source
1 1.05                         2.85    1450   0.994   0.004   0.002 Origin1
2 1.09                         3.71     780   1.000   0.000   0.000 Origin1
3 1.19                         2.71    1285   0.998   0.002   0.000 Origin1
4 1.12                         2.51    1105   1.000   0.000   0.000 

Origin1
5 0.88                         3.56    1095   0.996   0.002   0.002 Origin1
6 0.92                         3.20    1060   1.000   0.000   0.000 Origin1
> nrow(data.frame(test_set[,c(1:19)]))
[1] 103
> test_set$p_to_buyPred <- predict(logitM,  newdata = data.frame(test_set[,c(1$
> class(test_set$p_to_buyPred)
[1] "numeric"
> head(test_set)
    origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
2  Origin1     1   14.20       1.76 2.45              15.2       112
5  Origin1     1   14.06       1.63 2.28              16.0       126
8  Origin1     1   13.73       1.50 2.70              22.5       101
10 Origin1     1   13.05       1.65 2.55              18.0        98
11 Origin1     1   13.88       1.89 2.59              15.0       101
18 Origin1     1   13.74 

      1.67 2.25              16.4       118
   Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins
2           3.27       3.39                 0.34            1.97
5           3.00       3.17                 0.24            2.10
8           3.00       3.25                 0.29            2.38
10          2.45       2.43                 0.29            1.44
11          3.25       3.56                 0.17            1.70
18          2.60       2.90                 0.21            1.62
   Color.intensity  Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2
2             6.75 1.05                         2.85    1450   0.994   0.004
5             5.65 1.09                         3.71     780   1.000   0.000
8             5.70 1.19                         2.71    1285   0.998   0.002
10            4.25 1.12                         2.51    1105   1.000   0.000
11            5.43 0.88                         3.56    1095   0.996   0.002
18            5.85 0.92                         3.20    1060   1.000   0.000
   Origin3  Source propensity_to_buy p_to_buyPred
2    0.002 Origin1                 1            1
5    0.000 Origin1                 1            1
8    0.000 Origin1                 1            1
10   0.000 Origin1                 1            1
11   0.002 Origin1                 1            1
18   0.000 Origin1                 1            1
> test_set$p_to_buyPred <- ifelse(test_set$p_to_

buyPred > 0.5,1,0)
> misClasificError <- mean(test_set$p_to_buyPred != test_set$propensity_to_buy)
> print(paste('Accuracy',1-misClasificError))
[1] "Accuracy 1"
> ####
> library(ROCR)
Loading required package: gplots

Attaching package: 'gplots'

The following object is masked from 'package:stats':

    lowess

Warning messages:
1: package 'ROCR' was built under R version 3.2.5
2: package 'gplots' was built under R version 3.2.5
> # p1 <- predict(logitM, newdata= data.frame(test_set[,c(1:19)]), type="respo$
> class(test_set$p_to_buyPred)
[1] "numeric"
> pr1 <- prediction(test_set$p_to_buyPred, test_set$propensity_to_buy)
> class(pr1)
[1] "prediction"

attr(,"package")
[1] "ROCR"
> prf1 <- performance(pr1, measure = "tpr", x.measure = "fpr")
> class(prf1)
[1] "performance"
attr(,"package")
[1] "ROCR"
> pdf("plot_prf1.pdf")
> plot(prf1, colorize = TRUE) # , text.adj = c(-0.2,1.7)
> dev.off()
null device
          1
> auc1 <- performance(pr1, measure = "auc")
> auc1 <- auc1@y.values[[1]]
> auc1
[

1] 1
> ####
> library(ROCR)
> p <- predict(logitM, newdata= data.frame(test_set[,c(1:19)]), type="response$
> class(p)
[1] "numeric"
> pr <- prediction(p, test_set$propensity_to_buy)
> class(pr)
[1] "prediction"
attr(,"package")
[1] "ROCR"
> prf <- performance(pr, measure = "tpr", x.measure = "fpr")
> class(prf)
[1] "performance"
attr(,"package")
[1] "ROCR"
> # plot(prf, colorize = TRUE) # , text.adj = c(-0.2,1.7)
> auc <- performance(pr, measure = "auc")
> auc <- auc@y.values[[1]]
> auc
[1] 1
> test_set2 <- data.frame(test_set[,c(1:19)])
> head(test_set2)
   origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
1 Origin1     1   14.20       1.76 2.45              15.2       112
2 Origin1     1   14.06       1.63 2.28              16.0       126
3 Origin1     1   13.73       1.50 2.70              22.5       101
4 Origin1     1   13.05       1.65 2.55              18.0        98
5 Origin1     1   13.88       1.89 2.59              15.0       101
6 Origin1     1   13.74       1.67 2.25              16.4       118
  Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins Color.intensity

1          3.27       3.39              0.34            1.97            6.75
2          3.00       3.17              0.24            2.10            5.65
3          3.00       3.25              0.29            2.38            5.70
4          2.45       2.43              0.29            1.44            4.25
5          3.25       3.56              0.17            1.70            5.43
6          2.60       2.90              0.21            1.62            5.85
   Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2 Origin3  Source
1 1.05                         2.85    1450   0.994   0.004   0.002 Origin1
2 1.09                         3.71     780   1.000   0.000   0.000 Origin1
3 1.19                         2.71    1285   0.998   0.002   0.000 Origin1
4 1.12                         2.51    1105   1.000   0.000   0.000 Origin1
5 0.88                         3.56    1095   0.996   0.002   0.002 Origin1
6 0.92                         3.20    1060   1.000   0.000   0.000 Origin1
> test_set3 <- cbind(test_set2, predict(logitM, newdata=test_set2, type = "lin$
> test_set3 <- within(test_set3, {
+ PredictedProb <- plogis(fit)
+ lower <- plogis(fit - (1.96 * se.fit))
+ upper <- plogis(fit + (1.96 * se.fit))
+ })
> head(test_set3)
   origin class Alcohol Malic.acid  Ash Alcanility.of.ash Magnesium
1 Origin1     1   14.20       1.76 2.45              15.2       112
2 Origin1     1   14.06       1.63 2.28              16.0       126
3 Origin1     1   13.73       1.50 2.70              22.5       101
4 Origin1     1   13.05       1.65 2.55              18.0        98
5 Origin1     1   13.88       1.89 2.59              15.0       101
6 Origin1     1   13.74       1.67 2.25              16.4       118
  Total.phenols Flavanoids Nonflavanoid.phenols Proanthocyanins Color.intensity
1          3.27       3.39              0.34            1.97            6.75
2          3.00       3.17              0.24            2.10            5.65
3          3.00       3.25              0.29            2.38            5.70
4          2.45       2.43              0.29            1.44            4.25
5          3.25       3.56              0.17            1.70            5.43
6          2.60       2.90              0.21            1.62            5.85
   Hue OD280.OD315.of.diluted.wines Proline Origin1 Origin2 Origin3  Source

1 1.05                         2.85    1450   0.994   0.004   0.002 Origin1
2 1.09                         3.71     780   1.000   0.000   0.000 Origin1
3 1.19                         2.71    1285   0.998   0.002   0.000 Origin1
4 1.12                         2.51    1105   1.000   0.000   0.000 Origin1
5 0.88                         3.56    1095   0.996   0.002   0.002 Origin1
6 0.92                         3.20    1060   1.000   0.000   0.000 Origin1
       fit   se.fit residual.scale upper lower PredictedProb
1 28.56607 97787.51              1     1     0             1
2 28.56607 97787.51              1     1     0             1
3 28.56607 97787.51              1     1     0             1
4 28.56607 97787.51              1     1     0             1
5 28.56607 97787.51              1     1     0             1
6 28.56607 97787.51              1     1     0             1
> library(ggplot2)
Warning message:
package 'ggplot2' was built under R version 3.2.5
> g <- ggplot(test_set3, aes(x = Source, y = PredictedProb, group=PredictedPro$
+ geom_line(aes(colour = PredictedProb), size = 1) + geom_point() +
+ geom_ribbon(aes(ymin = lower, ymax = upper, fill = PredictedProb), alpha = 0$
> res <- ggplot_build(g)
> bottom <- res[[2]]$panel_ranges[[1]]$y.range[1]
> top    <- res[[2]]$panel_ranges[[1]]$y.range[2]
> ggplot(test_set3, aes(x = Source, y = PredictedProb, group=PredictedProb)) +
+ geom_ribbon(aes(ymin = lower, ymax = upper, fill = PredictedProb), alpha=0.2$
+ geom_ribbon(aes(ymin=bottom, ymax=lower), fill="red", alpha=0.25) +

+ geom_ribbon(aes(ymin=upper, ymax=top), fill="green", alpha=0.25) +
+ geom_point() + geom_line()

```

## 摘要

本章简要讨论了预测葡萄酒产地的主要用例及其对预测分析的扩展，通过基于产地预测购买特定葡萄酒的倾向。它解释了在这两种情况下绘制输出的多种选择；我们创建了成对图以及包含线、点和带的复合图。您还看到了如何将回归线拟合到结果图中。