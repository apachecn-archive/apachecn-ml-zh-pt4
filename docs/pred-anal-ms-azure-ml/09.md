第八章

![image](../images/00007.jpeg)

构建预测性维护模型

领先的制造商现在正在投资预测性维护，这有可能降低成本，同时提高利润和客户满意度。尽管统计和制造等传统技术有所帮助，但该行业仍然受到严重的质量问题和组件故障时业务中断的高成本的困扰。机器学习的进步为提高客户满意度和减少服务停机时间提供了独特的机会。本章展示了如何使用 Microsoft Azure 机器学习为预测性维护构建模型。通过示例，我们将展示如何使用 Microsoft Azure 机器学习来构建、验证和部署预测性维护的预测性模型。

概观

根据故障检测专家、前美国宇航局客座研究员 Ahmet Duyar 的说法，制造业生产率下降的一个关键原因是设备故障和不必要的维护干预导致的资产效率低下。仅在美国，过度维护和生产力损失的成本估计为 7400 亿美元，因此我们显然需要更好的维护方法(Duyar，2011)。

预测性维护技术旨在预测设备何时应该进行维护，甚至在设备发生故障之前。通过准确预测组件故障，您可以减少计划外停机时间并延长设备寿命。预测性维护还可以节省成本，因为它提高了维修效率:工程师可以针对预测的故障进行维修，从而更快地完成工作。他们不需要花太多时间去寻找设备故障的原因。借助预测性维护，工厂操作员可以更加积极主动，甚至在设备出现故障之前就能解决问题。

有必要澄清预测性维护和预防性维护之间的区别，因为这两者经常被混淆。预防性维护是指通常提前计划的定期维护。虽然预防性维护是有用的，并且在许多情况下是必要的，但是它可能是昂贵的，并且对于捕捉在预定的约会之间出现的问题是无效的。相比之下，预测性维护的目的是在故障发生之前预测故障。

让我们以汽车维修为例来说明这种区别。当你买车时，经销商通常会根据时间或里程推荐常规服务。例如，一些汽车制造商建议在行驶 6000 英里和 10000 英里后提供全套服务。这是预防性维护的一个好例子。当您接近 6，000 英里时，您的经销商将发送提醒，提醒您安排全面服务。相比之下，通过预测性维护，许多汽车制造商更愿意通过传感器将数据从汽车传输到数据库系统，持续监控汽车的性能。有了这些数据，他们可以检测出你的变速器或同步带何时开始显示出即将发生故障的迹象，并给你打电话进行维修，不管你的车行驶了多少英里。

预测性维护是在设备正常运行期间进行的一种非破坏性监控。安装在设备上的传感器收集有价值的数据，这些数据可用于预测和预防故障。

当前用于预测性维护的技术包括振动分析、声学分析、红外监控、油分析和基于模型的状态建模。振动分析使用安装在电机上的加速度计等传感器来确定电机何时运行异常。据 Ahmet Duyar 称，振动分析是最广泛使用的状态监控方法，占所有售出系统的 85%。声学分析使用声波或超声波分析来检测旋转机器中的异常摩擦和应力。虽然声波技术可以检测机械设备中的问题，但超声波更加灵活，可以检测机械和电气设备中的问题。红外分析的应用范围最广，涵盖从低速到高速的设备以及机械和电气设备。

基于模型的状态监控使用数学模型来预测故障。这项技术首先由美国宇航局开发，有一个学习阶段，在这个阶段中，它学习正常运行条件的特征。学习阶段完成后，系统进入生产阶段，监控设备的状况。它将设备的性能与学习阶段收集的数据进行比较，如果检测到严重偏离机器正常运行的情况，它将标记一个问题。这是一种异常检测形式，当机器明显偏离正常工作条件时，监控系统会标记出问题。

![Image](../images/00013.jpeg) **注**有关预测性维护的更多详情，请参考以下资源:

```
http://en.wikipedia.org/wiki/Predictive_maintenance  and
```

Ahmet Duyar，“简化预测性维护”，《轨道》第 31 卷第 1 期，第 38-45 页，2011 年。

商业问题

假设你是一家半导体制造商的数据科学家。你的雇主希望你做以下事情:

*   建立一个模型，预测生产过程中的产量损失，以及
*   通过你的分析，提供在他们的过程中导致产量失败的因素。

对于半导体制造商来说，这是一个非常重要的商业问题，因为他们的工艺可能很复杂，涉及从原材料到最终集成电路的几个阶段。鉴于这种复杂性，有几个因素会导致制造过程下游的成品率下降。识别最重要的因素将有助于工艺工程师提高产量，降低错误率和生产成本，从而提高生产率。

![Image](../images/00013.jpeg) **注意**你需要有一个 Azure 机器学习的账户。如果您还没有新帐户，请参考第 2 章中的[获取设置新帐户的说明。](03.html)

在[第 1 章](02.html)中，您看到数据科学流程通常遵循以下五个步骤。

1.  定义业务问题
2.  数据采集和准备
3.  模型开发
4.  模型部署
5.  监控模型性能

定义了业务问题后，您将在本章的剩余部分探索数据获取和准备、模型开发、评估和部署。

数据采集和准备

让我们来探索如何从源系统加载数据，并在 Azure 机器学习中分析数据。

数据集

对于本练习，您将使用加州大学欧文分校机器学习数据库中的 SECOM 数据集。这个来自半导体制造业的数据集是由迈克尔·麦肯和安卓·杰森提供的。

![Image](../images/00013.jpeg) **注**SECOM 数据集可在加州大学欧文分校的机器学习库中获得。数据集包含 1，567 个示例，每个示例包含 591 个要素。在 1567 个例子中，有 104 个代表了屈服失败。

这些特征或列表示制造过程中 590 个点的传感器读数。此外，它还包括每个示例的时间戳和产出结果(即简单的通过或失败)。

参考[http://archive . ics . UCI . edu/ml/machine-learning-databases/secom/](http://archive.ics.uci.edu/ml/machine-learning-databases/secom/)。

数据加载

Azure Machine Learning 使您能够从多个来源加载数据，包括本地机器、Web、Azure 上的 SQL 数据库、Hive 表或 Azure Blob 存储。

从本地文件系统加载数据

加载数据最简单的方法是从你的本地机器。您可以通过以下步骤做到这一点。

1.  将你的浏览器指向[https://studio.azureml.net](https://studio.azureml.net)，然后在 Azure Machine Learning 中登录你的工作区。
2.  接下来，从左侧窗格的菜单中单击**实验**项目。
3.  Click the **+New** button at the bottom left side of the window, and then select **Dataset** from the new menu shown in [Figure 8-1](#Fig1).

    ![9781484204467_Fig08-01.jpg](../images/00129.jpeg)

    [图 8-1](#_Fig1) 。从本地机器加载新数据集

4.  当您从本地文件中选择选项**时，系统会提示您选择要从机器中加载的数据文件。**

从其他来源加载数据

你可以使用 Azure Machine Learning 中的 **Reader** 模块从非本地来源加载数据。具体来说，通过**阅读器**模块，你可以从 Web、Azure 上的 SQL 数据库、Azure Table、Azure Blob 存储或 Hive 表中加载数据。为此，您必须在调用**阅读器**模块之前创建一个新的实验。使用以下步骤通过**阅读器**模块从上述任何来源加载数据。

1.  将你的浏览器指向[https://studio.azureml.net](https://studio.azureml.net)，然后在 Azure Machine Learning 中登录你的工作区。
2.  接下来，从左侧窗格的菜单中单击**实验**项目。
3.  Click the **+New** button at the bottom left side of the window, and then select **Experiment** from the new menu. A new experiment is launched with a blank canvas, as shown in [Figure 8-2](#Fig2).

    ![9781484204467_Fig08-02.jpg](../images/00130.jpeg)

    [图 8-2](#_Fig2) 。开始 Azure 机器学习的新实验

4.  打开菜单项**数据输入输出**，你会看到两个模块，**阅读器**和**写入器**。
5.  将**阅读器**模块从菜单拖到画布上的任意位置。
6.  在画布中点击**阅读器**模块，其属性会显示在右侧窗格的**阅读器**下。现在，在下拉菜单中指定数据源，然后输入所有必需参数的值。帐户名和帐户密钥引用 Microsoft Azure 上的存储帐户。您可以从 Azure 门户获取这些参数，如下所示:
    1.  在[http://azure.microsoft.com](http://azure.microsoft.com)登录微软 Azure。
    2.  在顶部菜单上，点击**门户**。这将带你到 Azure 门户。
    3.  从左侧窗格的菜单中选择**存储**。这将在右窗格中列出您的所有存储帐户。
    4.  单击包含机器学习模型所需数据的存储帐户。
    5.  在屏幕底部，点击标有**管理访问密钥**的密钥图标。将显示您的存储帐户名称和访问密钥。在 Azure 机器学习的**阅读器**模块中，使用**主访问密钥**作为你的账户密钥。

![Image](../images/00013.jpeg) **注意**你可以使用上面的指令将多个来源的几个数据集加载到 Azure Machine Learning 中。然而，请注意，每个**阅读器**模块一次只加载一个数据集。

对于这个项目，从 UCI 机器学习数据库导入两个 SECOM 数据集，并将它们连接到本地存储的一个新文件中。第一个数据集只有传感器读数，而第二个数据集有标签(即产量数据)。然后使用上面的第一种方法将连接的数据集加载到 Azure 机器学习中。

数据分析

[图 8-3](#Fig3) 显示了实验的第一部分，包括数据准备。使用**缺失值洗涤器**模块加载数据并对缺失值进行预处理。随后，获得汇总统计数据，并使用基于**过滤器的特征选择**模块来确定最重要的预测变量。

![9781484204467_Fig08-03.jpg](../images/00131.jpeg)

[图 8-3](#_Fig3) 。预处理 SECOM 数据集

[图 8-4](#Fig4) 显示了在 Azure 机器学习中看到的 SECOM 数据的快照。如您所见，数据集中有 1，567 行和 592 列。此外，Azure Machine Learning 还显示了每个特征的唯一值的数量和缺失值的数量。您可以看到许多传感器都有缺失值。此外，一些传感器对于所有行具有恒定的读数。例如，传感器#6 的所有行的读数都是 100。这些特征必须被消除，因为它们对预测没有价值，因为它们的读数没有变化。

![9781484204467_Fig08-04.jpg](../images/00132.jpeg)

[图 8-4](#_Fig4) 。在 Azure 机器学习中可视化 SECOM 数据集

特征选择

在这种情况下，功能选择至关重要，因为它为您的第二个业务问题提供了答案。事实上，对于超过 590 个特征，您必须执行特征选择，以识别对构建良好模型有用的特征子集，并消除不相关和冗余的特征。有了这么多的特性，你就有了维数灾难的风险。如果有大量的特征，学习问题可能是困难的，因为许多“额外的”特征可能混淆学习算法并导致它具有高方差。还需要注意的是，机器学习算法是非常计算密集型的，减少特征的数量可以大大减少所需的时间和训练模型，使数据科学家能够在更短的时间内进行实验。通过仔细选择特征，您可以找到对预测最有影响的变量。我们来看看如何在 Azure 机器学习中做特征选择。

要在 Azure Machine Learning 中执行功能选择，请从左侧窗格的模块列表中拖动名为**Filter Based Feature Selection**的模块。您可以通过在搜索框中搜索或打开**功能选择**类别找到该模块。要使用这个模块，您需要将它连接到一个数据集作为输入。[图 8-5](#Fig5) 显示了如何使用它对 SECOM 数据集进行特征选择。在运行实验之前，使用右窗格中的**启动列选择器** 来定义预测的目标变量。在这种情况下，选择列 **Yield_Pass_Fail** 作为目标，因为这是您希望预测的。完成后，将所需功能的数量设置为 100。这指示 Azure 机器学习中的特征选择器找到前 100 个变量。

![9781484204467_Fig08-05.jpg](../images/00133.jpeg)

[图 8-5](#_Fig5) 。Azure 机器学习中的特征选择

您还需要选择将用于特征选择的评分方法。Azure 机器学习提供了以下评分选项:

*   皮尔逊相关
*   交互信息
*   肯德尔相关
*   斯皮尔曼相关
*   卡方
*   菲舍尔评分
*   基于计数的

相关方法寻找与输出高度相关的变量集，但它们之间的相关性很低。根据您选择的选项，使用 Pearson、Kendall 或 Spearman 相关系数计算相关性。

费希尔评分 使用统计学中的费希尔标准对变量进行排名。相比之下，互信息选项是一种信息论方法，它使用互信息对变量进行排序。互信息测量每个变量的概率密度和结果变量的概率密度之间的相关性。

最后，卡方选项使用独立性测试来选择最佳特征；换句话说，它测试每个变量是否独立于结果变量。然后使用卡方检验对变量进行排序。

![Image](../images/00013.jpeg) **注**关于特征选择策略的更多信息，参见[http://en . Wikipedia . org/wiki/Feature _ selection # Correlation _ Feature _ selection](http://en.wikipedia.org/wiki/Feature_selection#Correlation_feature_selection)或[http://jmlr.org/papers/volume3/guyon03a/guyon03a.pdf](http://jmlr.org/papers/volume3/guyon03a/guyon03a.pdf)。

当你运行实验时，基于**过滤器的特征选择**模块产生两个输出:首先，过滤后的数据集列出了最重要变量的实际数据。第二，该模块按重要性显示变量列表，以及每个所选变量的分数。[图 8-6](#Fig6) 显示了特性的结果。在这种情况下，您将特征的数量设置为 100，并使用互信息对变量进行评分和排序。[图 8-6](#Fig6) 显示了 101 列，因为结果集包括目标变量(即 Yield_Pass_Fail)加上前 100 个变量，包括传感器#60、传感器#248、传感器#520、传感器#104 等。结果的最后一行显示了每个所选变量的得分。由于变量是有排名的，所以分数从左到右递减。

![9781484204467_Fig08-06.jpg](../images/00134.jpeg)

[图 8-6](#_Fig6) 。显示顶级变量的 SECOM 数据集的特征选择结果

请注意，所选变量将根据评分方法而有所不同，因此在选择最终变量集之前，值得尝试不同的评分方法。卡方和互信息评分方法为 SECOM 数据集产生了类似的变量排序。

训练模型

完成数据预处理后，下一步是训练模型来预测产量。由于响应变量是二进制的，您可以将此视为二进制分类问题。你可以使用 Azure 机器学习中的任何两类分类算法，如两类逻辑回归、两类提升决策树、两类决策森林、两类神经网络等。

![Image](../images/00013.jpeg) **注意**所有的预测性维护问题都是不平等的。有些问题除了分类之外，还需要不同的技术。例如，如果目标是确定 ***什么时候*** 一个零件会失效，你将需要使用生存分析。或者，如果目标是预测能源消耗，您可以使用预测连续结果的预测技术或回归方法。因此，您需要了解业务问题，以便找到最合适的技术来使用。一种尺寸不适合所有人！

[图 8-7](#Fig7) 显示了根据 SECOM 数据预测产量的完整实验。实验的上半部分，直到**分割**模块，实现了数据预处理阶段。 **Split** 模块将数据分成两个样本，一个训练样本包含初始数据集的 70%，一个测试样本包含剩余的 30%。

![9781484204467_Fig08-07.jpg](../images/00135.jpeg)

[图 8-7](#_Fig7) 。从 SECOM 数据预测产量的试验

在本实验中，您将比较两种分类算法，以找到产量的最佳预测值。 **Split** 模块后的左分支使用二类提升决策树，右分支使用统计学中广泛使用的二类 logistic 回归算法。这些算法中的每一个都用相同的训练样本进行训练，并用相同的测试样本进行测试。您使用名为**的训练模型**来训练每个算法，并使用**分数模型**来进行测试。名为**评估模型**的模块用于评估这两个分类模型的准确性。

模型测试和验证

一旦模型被训练，下一个步骤是用保留样本测试它，以避免过度拟合和评估模型泛化。我们已经展示了如何使用 30%的样本来测试训练好的模型。另一个避免过度拟合和评估模型泛化的策略是交叉验证，这在第 6 章中讨论过。默认情况下，Azure 机器学习使用 10 重交叉验证。使用这种方法，您可以使用 10 个保留样本而不是 1 个进行测试。要对此问题进行交叉验证，您可以简单地用名为**交叉验证模型**的模块替换任意一对**训练模型**和**得分模型**模块。[图 8-8](#Fig8) 显示了如何使用本实验的**两类逻辑回归**部分进行交叉验证。您还需要使用来自基于特征选择 的**过滤器的整个数据集作为您的输入数据集。对于交叉验证，不需要使用**分割**模块将数据分割成训练集和测试集，因为名为**交叉验证模型**的模块会进行所需的数据分割。**

![9781484204467_Fig08-08.jpg](../images/00136.jpeg)

[图 8-8](#_Fig8) 。交叉验证的改良实验

模型性能

**评估模型**模块用于测量已训练模型的性能。该模块将两个数据集作为输入。第一个是来自测试模型的评分数据集。第二个是用于比较的可选数据集。运行实验后，您可以通过单击名为**评估模型**的模块底部的小圆圈来检查您的模型的性能。本模块提供以下方法来衡量分类模型(如倾向模型)的绩效:

*   受试者工作特征，或 ROC 曲线，绘制真阳性与假阳性的比率
*   提升曲线(也称为增益曲线)，它绘制了真正阳性的数量与阳性率的关系
*   精确度与召回率图表
*   显示 I 型和 II 型错误的混淆矩阵

[图 8-9](#Fig9) 显示了您之前建立的倾向模型的 ROC 曲线。ROC 曲线直观地显示了预测性二元分类模型的性能。图表上从(0，0)到(1，1)的对角线表示随机猜测的表现；所以如果你随机选择收益率，你的反应会在这条对角线上。一个好的预测模型应该比随机猜测好得多。因此，在 ROC 曲线上，一个好的模型应该位于对角线之上。100%准确的理想或完美模型将有一条从(0，0)到(0，1)的垂直线，后面是一条从(0，1)到(1，1)的水平线。

![9781484204467_Fig08-09.jpg](../images/00137.jpeg)

[图 8-9](#_Fig9) 。两条 ROC 曲线比较了 logistic 回归和 boosted 决策树模型在产量预测中的性能

从 ROC 曲线测量性能的一种方法是测量曲线下面积(AUC)。曲线下的面积越大，模型的性能越好。理想模型的 AUC 为 1.0，而随机猜测的 AUC 为 0.5。您构建的逻辑回归模型的 AUC 为 0.667，而增强决策树模型的 AUC 略高，为 0.741！在这个实验中，两类提升决策树具有以下参数:

*   每棵树的最大叶子数= 50
*   形成叶子所需的最大训练实例数= 10
*   学习率= 0.4
*   建造的树木数量= 1000
*   随机数种子= 1

此外，Azure 机器学习还提供了混淆矩阵以及这两种模型的精确度和召回率。通过单击两条曲线中的每一条，该工具显示所选模型的混淆矩阵、精确度和召回率。如果单击底部曲线或名为“要比较的评分数据集”的图例，该工具将显示逻辑回归模型的性能数据。

[图 8-10](#Fig10) 显示了逻辑回归模型的混淆矩阵。混淆矩阵有以下四个单元:

*   **真阳性**:这些是 yield 失败的情况，并且模型正确地预测了这种情况。
*   **真阴性**:在历史数据集中，收益率通过，模型正确预测通过。
*   **假阳性**:在这种情况下，模型错误地预测产量将失败，而实际上它是通过的。这通常被称为 I 型误差。您构建的增强决策树模型只有两个误报。
*   **假阴性**:这里模型错误地预测收益率会通过，而实际上它失败了。这也被称为第二类错误。增强的决策树模型有 27 个假阴性。

![9781484204467_Fig08-10.jpg](../images/00138.jpeg)

[图 8-10](#_Fig10) 。困惑矩阵和更多性能指标

此外，[图 8-10](#Fig10) 显示了模型的准确度、精确度和召回率。这些指标的公式如下:

精度是结果中真正阳性的比率。

![image](../images/00139.jpeg)

召回率是模型识别的购买者的百分比，衡量方法是

![image](../images/00140.jpeg)

最后，准确性衡量模型正确识别买家和非买家的程度，如下所示

![image](../images/00141.jpeg)

其中 tp =真阳性，tn =真阴性，fp =假阳性，fn =假阴性。F1 分数是精确度和召回率的加权平均值。在这种情况下，由于召回率很低，所以它相当低。

模型部署

当您构建并测试满足您需求的预测模型时，您可以使用 Azure 机器学习将其部署到生产中以供业务使用。Azure 机器学习的一个关键优势是易于在生产中部署。一旦模型完成，就可以很容易地作为 web 服务部署到生产中。部署后，该模型可以作为 web 服务从多个设备调用，包括服务器、笔记本电脑、平板电脑，甚至智能手机。

将模型部署到生产环境中需要以下两个步骤。

1.  将您的实验发布到 Azure Machine Learning Studio 的登台环境中。
2.  从 Azure 管理门户，将实验从试运行环境转移到生产环境中。

让我们详细回顾一下这些步骤，看看它们是如何应用到您在前面章节中构建的最终模型的。

将您的模型发布到 Staging

要将您的模型部署到 staging 中，请在 Azure Machine Learning Studio 中遵循以下步骤。

1.  Save your trained mode using the **Save As** button at the bottom of Azure Machine Learning Studio. Rename it to a new name of your choice.
    1.  **运行**实验。
    2.  右键单击训练模块的输出(如**训练模型**，选择选项**另存为训练模型。**
    3.  删除任何用于训练的模块(例如**分裂、两级提升决策树、训练模型、评估模型**)。
    4.  将新保存的模型直接连接到**评分模型**模块。
    5.  重新运行你的实验。

    在步骤 1c 删除之前，你的实验应该如图[图 8-11](#Fig11) 所示。

    ![9781484204467_Fig08-11.jpg](../images/00142.jpeg)

    [图 8-11](#_Fig11) 。训练模块被删除前的预测模型

    在删除训练模块并用保存的训练模型替换它们之后，实验现在应该出现如图[图 8-12](#Fig12) 所示。

    ![9781484204467_Fig08-12.jpg](../images/00143.jpeg)

    [图 8-12](#_Fig12) 。使用保存的训练模型的实验

2.  Next, set your publishing input and output data ports. To do this,
    1.  右键单击名为 **Score Model** 的模块的右输入端口。选择选项**设置为发布输入**。
    2.  右键单击**评分模型**模块的输出端口，选择**设置为发布输出**。

    在这两个步骤之后，您将会看到两个圆圈在 Score Model 模块上突出显示所选择的发布输入和输出。这在[图 8-12](#Fig12) 中显示。

3.  一旦分配了发布输入和输出端口，运行实验，然后通过单击屏幕底部的 **Publish Web Service** 将其发布到 staging 中。

将您的模型从试运行阶段转移到生产阶段

此时，您的模型已经在登台环境中，但是还没有在生产环境中运行。要将发布到生产环境中，您需要通过以下步骤将其从登台环境转移到生产环境中。

1.  在 Azure Machine Learning Studio 中配置您的新 web 服务，并使其准备好投入生产，如下所示:
    1.  在 Azure Machine Learning Studio 中，点击右侧窗格中名为 **Web Services** 的菜单。它将显示所有 web 服务的列表。
    2.  单击您刚刚创建的新服务的名称。点击**测试** URL 进行测试。
    3.  单击“配置”选项卡，然后为选项**选择“是”以准备生产？**点击窗口底部的**保存**按钮。现在，您的模型可以发布到产品中了。
2.  现在切换到 Azure 管理门户，将您的 web 服务发布到产品中，如下所示:
    1.  在 Azure 管理门户的右侧窗格中选择**机器学习**。
    2.  选择包含您想要在生产中部署的实验的工作区。
    3.  单击工作区的名称，然后单击名为 **Web Services 的选项卡。**
    4.  选择 Azure 管理门户窗口底部的**+添加**按钮。

恭喜你，你刚刚将你的机器学习模型发布到生产中。如果您从 **Web 服务**选项卡中单击您的模型，您将会看到详细信息，例如您的模型在七天时间内所做的预测数量。该服务还展示了 API，您可以使用这些 API 以请求/响应或批处理执行模式将您的模型作为 web 服务进行调用。此外，您还可以获得用 C#、Python 或 r 调用新 web 服务的示例代码。

摘要

你通过探索预测性维护开始了这一章，这显示了机器学习的商业机会和前景。使用加州大学欧文分校的机器学习数据仓库中的 SECOM 半导体制造数据，您了解了如何在 Azure 机器学习中构建和部署预测性维护解决方案。在本分步指南中，我们解释了如何执行数据预处理和分析，这对理解数据至关重要。了解了这些数据后，您使用两类逻辑回归和两类提升决策树算法来执行分类。您还看到了如何评估模型的性能并避免过度拟合。最后，您看到了如何在 Microsoft Azure 上将完成的模型部署为机器学习 web 服务。